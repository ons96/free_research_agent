<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Research Agent</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app">
        <header>
            <h1>Free Research Agent</h1>
            <div style="margin-top: 10px; font-size: 0.9em; color: #94a3b8;">
                $0 Cost • Fast • Private
            </div>
        </header>

        <div id="chat-container">
            <div class="message bot-message">
                Hello! I'm your free research assistant. I can chat, search the web, or perform deep research. How can I help?
            </div>
        </div>

        <form id="input-area">
            <select id="mode-select">
                <option value="chat">Chat</option>
                <option value="search">Search</option>
                <option value="research">Research</option>
            </select>
            <input type="text" id="user-input" placeholder="Type your message..." required autocomplete="off">
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const form = document.getElementById('input-area');
        const input = document.getElementById('user-input');
        const modeSelect = document.getElementById('mode-select');

        let chatHistory = [];

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}-message`;
            div.textContent = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        function appendStatus(text) {
            const div = document.createElement('div');
            div.className = 'status-message';
            div.textContent = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            const mode = modeSelect.value;
            input.value = '';
            
            // User Message
            appendMessage('user', message);
            chatHistory.push({role: 'user', content: message});

            // Bot placeholder
            const botMessageDiv = appendMessage('bot', '');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        mode: mode,
                        history: chatHistory.slice(-10) // Keep context small for free models
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                
                                if (data.status) {
                                    appendStatus(data.status);
                                } else if (data.token) {
                                    fullResponse += data.token;
                                    botMessageDiv.textContent = fullResponse;
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                } else if (data.error) {
                                    botMessageDiv.textContent += ` [Error: ${data.error}]`;
                                }
                            } catch (e) {
                                console.error('JSON parse error', e);
                            }
                        }
                    }
                }
                
                chatHistory.push({role: 'assistant', content: fullResponse});

            } catch (error) {
                botMessageDiv.textContent += ` [Error: ${error.message}]`;
            }
        };
    </script>
</body>
</html>
